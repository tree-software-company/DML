version: 2.1

jobs:
  build:
    docker:
      - image: cimg/openjdk:17.0
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt update
            sudo apt install -y curl unzip
            curl -s "https://get.sdkman.io" | bash
            source "$HOME/.sdkman/bin/sdkman-init.sh"
            sdk install gradle
            gradle --version
      - run:
          name: Build JAR
          command: gradle build
      - run:
          name: Generate SHA256
          command: |
            shasum -a 256 build/libs/DML-all.jar | awk '{ print $1 }' > checksum.txt
      - run:
          name: Setup SSH
          command: |
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts
      - run:
          name: Clone and update homebrew-dml formula
          command: |
            git config --global user.name "simon04PL"
            git config --global user.email "szymon.msa@gmail.com"
            
            git clone git@github.com:tree-software-company/homebrew-dml.git
            cd homebrew-dml

            SHA256=$(cat ../checksum.txt)
            NEW_VERSION="0.1.1" 

            cat > dml.rb <<EOF
            class Dml < Formula
              desc "Custom DSL for data definition like JSON, with Kotlin & ANTLR"
              homepage "https://github.com/tree-software-company/dml"
              url "https://github.com/tree-software-company/DML/releases/download/${NEW_VERSION}/DML-all.jar"
              version "${NEW_VERSION}.1"
              sha256 "${SHA256}"
              license "Apache-2.0"

              def install
                libexec.install "DML-all.jar"
                (bin/"dml").write <<~EOS
                  #!/bin/bash
                  exec java -jar "\#{libexec}/DML-all.jar" "\$@"
                EOS
              end

              test do
                assert_match "DML Command Line Interface", shell_output("\#{bin}/dml help")
              end
            end

            git add dml.rb
            if ! git diff --cached --quiet; then
              git commit -m "Update formula with new release"
              git push git@github.com:tree-software-company/homebrew-dml.git HEAD:main
            else
              echo "No changes to commit"
            fi

workflows:
  version: 2
  build-and-publish:
    jobs:
      - build
